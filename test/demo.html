<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsForge è®¤è¯æ¼”ç¤º - JWT Token ç”Ÿæˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fa fa-database"></i> InsForge äº‘ç«¯æ•°æ®åº“ + JWT è®¤è¯æ¼”ç¤º
            </h1>
            <p class="text-gray-600 mt-2">æ•°æ®åº“å·²éƒ¨ç½²åˆ°äº‘ç«¯ï¼šhttps://2t46q3eu.us-west.insforge.app</p>
        </header>

        <!-- è¯´æ˜åŒºåŸŸ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">
                <i class="fa fa-info-circle"></i> ç³»ç»Ÿè¯´æ˜
            </h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold text-gray-700 mb-2">âœ… å·²éƒ¨ç½²çš„æ•°æ®åº“è¡¨</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li><code class="bg-gray-100 px-2 py-1 rounded">profiles</code> - ç”¨æˆ·æ‰©å±•ä¿¡æ¯è¡¨</li>
                        <li><code class="bg-gray-100 px-2 py-1 rounded">user_data</code> - ç”¨æˆ·æ•°æ®è¡¨</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-gray-700 mb-2">ğŸ” è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®</li>
                        <li>ç”¨æˆ·åªèƒ½æ’å…¥/æ›´æ–°/åˆ é™¤è‡ªå·±çš„æ•°æ®</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- JWT Token ç”Ÿæˆ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">
                <i class="fa fa-key"></i> JWT Token ç”Ÿæˆ
            </h2>
            <p class="text-gray-600 mb-4">ç”Ÿæˆä¸€ä¸ªæ¨¡æ‹Ÿçš„ JWT Token ç”¨äºæ¼”ç¤ºï¼ˆåœ¨å®é™…ç”Ÿäº§ä¸­åº”é€šè¿‡ InsForge OAuth è·å–çœŸå® Tokenï¼‰</p>
            <button
                onclick="generateMockToken()"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
            >
                <i class="fa fa-magic"></i> ç”Ÿæˆæ¨¡æ‹Ÿ JWT Token
            </button>
        </div>

        <!-- æ•°æ®ç®¡ç†åŒºåŸŸ -->
        <div id="data-section" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">
                <i class="fa fa-database"></i> æ•°æ®ç®¡ç†
            </h2>

            <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-gray-700 mb-2">å½“å‰æ¨¡æ‹Ÿç”¨æˆ·</h3>
                <div id="user-info" class="text-sm text-gray-600"></div>
            </div>

            <!-- æäº¤æ•°æ®è¡¨å• -->
            <form onsubmit="submitData(event)" class="mb-6">
                <h3 class="text-lg font-medium mb-3 text-gray-700">æ·»åŠ æ–°æ•°æ®</h3>
                <div class="grid md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">æ ‡é¢˜</label>
                        <input
                            id="data-title"
                            type="text"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="è¾“å…¥æ ‡é¢˜"
                        >
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">å†…å®¹</label>
                        <textarea
                            id="data-content"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                            rows="2"
                            placeholder="è¾“å…¥å†…å®¹"
                        ></textarea>
                    </div>
                </div>
                <button
                    type="submit"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                >
                    <i class="fa fa-plus"></i> æäº¤åˆ°äº‘ç«¯æ•°æ®åº“
                </button>
            </form>

            <button
                onclick="loadData()"
                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 mb-4"
            >
                <i class="fa fa-refresh"></i> åˆ·æ–°æ•°æ®
            </button>

            <div>
                <h3 class="text-lg font-medium mb-3 text-gray-700">æˆ‘çš„äº‘ç«¯æ•°æ®</h3>
                <div id="data-list" class="grid md:grid-cols-2 gap-4">
                    <p class="text-gray-500 text-sm col-span-2">æš‚æ— æ•°æ®</p>
                </div>
            </div>
        </div>

        <!-- API è°ƒç”¨æ—¥å¿— -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">
                <i class="fa fa-terminal"></i> API è°ƒç”¨æ—¥å¿—
            </h2>
            <div id="api-log" class="bg-gray-900 text-green-400 p-4 rounded-lg text-xs font-mono overflow-y-auto max-h-96">
                <p class="text-gray-500">// ç­‰å¾…æ“ä½œ...</p>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message" class="fixed top-4 right-4 max-w-sm hidden"></div>
    </div>

    <script>
        const CONFIG = {
            baseUrl: 'https://2t46q3eu.us-west.insforge.app',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3OC0xMjM0LTU2NzgtOTBhYi1jZGVmMTIzNDU2NzgiLCJlbWFpbCI6ImFub25AaW5zZm9yZ2UuY29tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4ODU0MTZ9.MmTpyJQoCsiILWhNRYEMMeVQG9btPKS6bbfDwB1u_1g'
        };

        let mockUser = null;
        let mockToken = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('api-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400',
                request: 'text-yellow-400',
                response: 'text-cyan-400'
            };
            logDiv.innerHTML += `<p class="${colors[type]}">[${timestamp}] ${message}</p>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿ JWT Token
        function generateMockToken() {
            log('å¼€å§‹ç”Ÿæˆæ¨¡æ‹Ÿ JWT Token...', 'info');

            // ç”Ÿæˆæ¨¡æ‹Ÿç”¨æˆ· ID
            const userId = 'user-' + Math.random().toString(36).substr(2, 9);
            const email = `user${Math.floor(Math.random() * 1000)}@example.com`;

            mockUser = {
                id: userId,
                email: email,
                role: 'authenticated'
            };

            // ç”Ÿæˆæ¨¡æ‹Ÿ JWT payload
            const payload = {
                sub: userId,
                email: email,
                role: 'authenticated',
                iat: Math.floor(Date.now() / 1000),
                exp: Math.floor(Date.now() / 1000) + (24 * 60 * 60) // 24å°æ—¶è¿‡æœŸ
            };

            // ç”Ÿæˆç®€å•çš„ JWTï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
            const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
            const body = btoa(JSON.stringify(payload));
            const signature = 'mock-signature-' + Math.random().toString(36).substr(2);
            mockToken = `${header}.${body}.${signature}`;

            log(`âœ… æ¨¡æ‹Ÿç”¨æˆ·å·²åˆ›å»º: ${email}`, 'success');
            log(`âœ… æ¨¡æ‹Ÿ Token å·²ç”Ÿæˆ (å‰50å­—ç¬¦): ${mockToken.substring(0, 50)}...`, 'success');

            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            document.getElementById('user-info').innerHTML = `
                <p><strong>ç”¨æˆ· ID:</strong> ${userId}</p>
                <p><strong>é‚®ç®±:</strong> ${email}</p>
                <p><strong>è§’è‰²:</strong> authenticated</p>
                <p class="mt-2 text-xs text-gray-500"><strong>æ³¨æ„:</strong> è¿™æ˜¯æ¨¡æ‹Ÿ Tokenï¼Œå®é™…ç”Ÿäº§ä¸­åº”é€šè¿‡ InsForge OAuth è·å–çœŸå® Token</p>
            `;

            document.getElementById('data-section').classList.remove('hidden');
            showMessage('æ¨¡æ‹Ÿ Token ç”ŸæˆæˆåŠŸï¼', 'success');

            // è‡ªåŠ¨åŠ è½½æ•°æ®
            loadData();
        }

        // æäº¤æ•°æ®
        async function submitData(e) {
            e.preventDefault();

            const title = document.getElementById('data-title').value;
            const content = document.getElementById('data-content').value;

            log(`ğŸ“¤ å‡†å¤‡æäº¤æ•°æ®åˆ°äº‘ç«¯...`, 'request');
            log(`POST ${CONFIG.baseUrl}/rest/v1/user_data`, 'request');
            log(`Body: [{"user_id":"${mockUser.id}","title":"${title}","content":"${content}"}]`, 'request');

            try {
                const response = await fetch(`${CONFIG.baseUrl}/rest/v1/user_data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': CONFIG.anonKey,
                        'Authorization': `Bearer ${mockToken}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify([{
                        user_id: mockUser.id,
                        title,
                        content
                    }])
                });

                log(`ğŸ“¥ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'æäº¤å¤±è´¥');
                }

                const data = await response.json();
                log(`âœ… æ•°æ®æäº¤æˆåŠŸ! ID: ${data[0].id}`, 'success');

                document.getElementById('data-title').value = '';
                document.getElementById('data-content').value = '';

                showMessage('æ•°æ®æäº¤æˆåŠŸï¼', 'success');
                loadData();
            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`, 'error');
                showMessage(error.message, 'error');
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            log(`ğŸ“¥ å‡†å¤‡ä»äº‘ç«¯åŠ è½½æ•°æ®...`, 'request');
            log(`GET ${CONFIG.baseUrl}/rest/v1/user_data?user_id=eq.${mockUser.id}`, 'request');

            try {
                const response = await fetch(
                    `${CONFIG.baseUrl}/rest/v1/user_data?user_id=eq.${mockUser.id}&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': CONFIG.anonKey,
                            'Authorization': `Bearer ${mockToken}`
                        }
                    }
                );

                log(`ğŸ“¥ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const data = await response.json();
                log(`âœ… æˆåŠŸåŠ è½½ ${data.length} æ¡æ•°æ®`, 'success');

                const list = document.getElementById('data-list');
                if (!data || data.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-sm col-span-2">æš‚æ— æ•°æ®</p>';
                } else {
                    list.innerHTML = data.map(item => `
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <h4 class="font-semibold text-gray-800">${escapeHtml(item.title)}</h4>
                            <p class="text-sm text-gray-600 mt-2">${escapeHtml(item.content)}</p>
                            <p class="text-xs text-gray-400 mt-2">
                                <i class="fa fa-clock-o"></i> ${new Date(item.created_at).toLocaleString('zh-CN')}
                            </p>
                            <p class="text-xs text-gray-400">
                                <i class="fa fa-database"></i> ID: ${item.id}
                            </p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const msg = document.getElementById('message');
            msg.className = `fixed top-4 right-4 max-w-sm ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg`;
            msg.textContent = text;
            msg.classList.remove('hidden');

            setTimeout(() => msg.classList.add('hidden'), 3000);
        }

        // åˆå§‹åŒ–
        log('ğŸš€ InsForge è®¤è¯æ¼”ç¤ºå·²å¯åŠ¨', 'info');
        log(`ğŸ“ åç«¯åœ°å€: ${CONFIG.baseUrl}`, 'info');
        log(`ğŸ”‘ Anon Key: ${CONFIG.anonKey.substring(0, 20)}...`, 'info');
    </script>
</body>
</html>
